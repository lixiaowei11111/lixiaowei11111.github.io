---
title: "qiankun å¾®å‰ç«¯å®è·µæŒ‡å—"
excerpt: "æ·±å…¥æ¢è®¨ qiankun å¾®å‰ç«¯æ¶æ„çš„å®Œæ•´å®è·µï¼ŒåŒ…æ‹¬é¡¹ç›®æ­å»ºã€åº”ç”¨é—´é€šä¿¡ã€æ ·å¼éš”ç¦»ã€éƒ¨ç½²ç­–ç•¥ä»¥åŠå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆã€‚"
author: "LXW"
publishedAt: "2024-12-19"
updatedAt: "2024-12-19"
tags: ["å¾®å‰ç«¯", "qiankun", "Architecture", "React", "Vue"]
category: "frontend"
featured: true
coverImage: "/images/posts/covers/qiankun-guide.jpg"
---

# qiankun å¾®å‰ç«¯å®è·µæŒ‡å—

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº qiankun çš„å¾®å‰ç«¯æ¶æ„å®è·µç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•æ„å»ºä¸€ä¸ªå®Œæ•´çš„å¾®å‰ç«¯åº”ç”¨ç³»ç»Ÿã€‚qiankun æ˜¯ä¸€ä¸ªåŸºäº single-spa çš„å¾®å‰ç«¯å®ç°åº“ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å‹å‰ç«¯åº”ç”¨è¿›è¡Œæ¨¡å—åŒ–æ‹†åˆ†å’Œæ²»ç†ã€‚

é¡¹ç›®é€šè¿‡ä¸€ä¸ªä¸»åº”ç”¨ï¼ˆmainï¼‰å’Œå¤šä¸ªå­åº”ç”¨ï¼ˆflowã€backendã€formã€hashï¼‰ç»„æˆï¼Œå®ç°äº†æ¨¡å—é—´çš„ç‹¬ç«‹å¼€å‘ã€éƒ¨ç½²å’Œè¿è¡Œï¼ŒåŒæ—¶ä¿æŒäº†æ•´ä½“åº”ç”¨çš„ä¸€è‡´æ€§ä½“éªŒã€‚

## é¡¹ç›®æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„æ¦‚è§ˆ

é¡¹ç›®é‡‡ç”¨äº†å…¸å‹çš„å¾®å‰ç«¯æ¶æ„ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

1. **ä¸»åº”ç”¨ï¼ˆMainï¼‰**ï¼šä½œä¸ºåŸºåº§åº”ç”¨ï¼Œè´Ÿè´£å­åº”ç”¨çš„æ³¨å†Œã€åŠ è½½å’Œå¸è½½ï¼Œæä¾›å…¬å…±å¯¼èˆªå’ŒåŸºç¡€è®¾æ–½ã€‚
2. **å­åº”ç”¨**ï¼šç‹¬ç«‹å¼€å‘ã€æ„å»ºå’Œéƒ¨ç½²çš„å¾®å‰ç«¯åº”ç”¨ï¼ŒåŒ…æ‹¬ï¼š
   - **flow**: åŸºäº React å¼€å‘
   - **backend**: åŸºäº Vue å¼€å‘
   - **form**: åŸºäº React å¼€å‘
   - **hash**: åŸºäº Vue å¼€å‘

### ç›®å½•ç»“æ„è®¾è®¡

é¡¹ç›®é‡‡ç”¨äº† monorepo å·¥ä½œåŒºç»“æ„ï¼Œä½¿ç”¨ pnpm workspace è¿›è¡Œç®¡ç†ï¼š

```
micro_qiankun/
â”œâ”€â”€ app/                    # æ‰€æœ‰åº”ç”¨ç›®å½•
â”‚   â”œâ”€â”€ main/               # ä¸»åº”ç”¨ï¼ˆåŸºåº§ï¼‰
â”‚   â”œâ”€â”€ flow/               # React å­åº”ç”¨
â”‚   â”œâ”€â”€ backend/            # Vue å­åº”ç”¨
â”‚   â”œâ”€â”€ form/               # React å­åº”ç”¨
â”‚   â””â”€â”€ hash/               # Vue å­åº”ç”¨
â”œâ”€â”€ nginx/                  # Nginx é…ç½®
â”œâ”€â”€ package.json            # æ ¹é¡¹ç›®é…ç½®
â””â”€â”€ pnpm-workspace.yaml     # pnpm å·¥ä½œåŒºé…ç½®
```

> ğŸ’¡ **æç¤º**: å¦‚æœä»“åº“ä½“ç§¯è†¨èƒ€ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ git submodule ç®¡ç†

### æŠ€æœ¯æ ˆé€‰æ‹©

- **æ„å»ºå·¥å…·**ï¼šRspackï¼ˆæ›¿ä»£ Webpackï¼‰
- **åŒ…ç®¡ç†**ï¼špnpmï¼ˆæ”¯æŒ workspaceï¼‰
- **å¾®å‰ç«¯æ¡†æ¶**ï¼šqiankun
- **å‰ç«¯æ¡†æ¶**ï¼šReactã€Vue
- **çŠ¶æ€ç®¡ç†**ï¼šzustand
- **éƒ¨ç½²å·¥å…·**ï¼šPM2ã€Nginx
- **å¼€å‘è¯­è¨€**ï¼šTypeScript

## å¾®å‰ç«¯å®ç°æ ¸å¿ƒ

### ä¸»åº”ç”¨æ³¨å†Œå­åº”ç”¨

ä¸»åº”ç”¨é€šè¿‡ qiankun çš„ `registerMicroApps` æ–¹æ³•æ³¨å†Œå­åº”ç”¨ï¼š

```typescript
import { registerMicroApps, start } from 'qiankun'

registerMicroApps([
  {
    name: 'backend',
    entry: isDev ? '//localhost:23456' : '/app-backend/',
    container: '#backend',
    activeRule: '/backend',
    props: {
      mainHistory: history,
      navigateToOtherApp: mainNavigate,
      getGlobalState: () => store.getState(),
    },
  },
  {
    name: 'flow',
    entry: isDev ? '//localhost:23457' : '/app-flow/',
    container: '#flow',
    activeRule: '/flow',
    props: {
      mainHistory: history,
      navigateToOtherApp: mainNavigate,
      getGlobalState: () => store.getState(),
    },
  },
  // å…¶ä»–å­åº”ç”¨é…ç½®...
])

// å¯åŠ¨ qiankun
start()
```

ä¸»åº”ç”¨é…ç½®ä¸­çš„å…³é”®å‚æ•°ï¼š
- `name`: å­åº”ç”¨å”¯ä¸€æ ‡è¯†
- `entry`: å­åº”ç”¨å…¥å£ï¼ˆå¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒé…ç½®ä¸åŒï¼‰
- `container`: å­åº”ç”¨æŒ‚è½½çš„ DOM å®¹å™¨
- `activeRule`: å­åº”ç”¨æ¿€æ´»çš„è·¯ç”±è§„åˆ™
- `props`: ä¼ é€’ç»™å­åº”ç”¨çš„æ•°æ®å’Œæ–¹æ³•

### å­åº”ç”¨ç”Ÿå‘½å‘¨æœŸå®ç°

å­åº”ç”¨éœ€è¦å¯¼å‡º qiankun æ‰€éœ€çš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼š`bootstrap`ã€`mount` å’Œ `unmount`ã€‚ä»¥ flow å­åº”ç”¨ä¸ºä¾‹ï¼š

```typescript
import React from 'react'
import { createRoot } from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom'
import App from './App'

let root: any = null

export const bootstrap = async () => {
  console.log('[debug] react-flow-app bootstrap')
}

export const mount = async (props: QiankunMountProps) => {
  console.log('[debug] react-flow-app mounted.props from main framework', props)
  
  const { container } = props
  const containerElement = container
    ? container.querySelector('#root')
    : document.querySelector('#root')

  root = createRoot(containerElement)
  root.render(
    <BrowserRouter basename={window.__POWERED_BY_QIANKUN__ ? '/flow' : '/'}>
      <App {...props} />
    </BrowserRouter>
  )
}

export const unmount = async () => {
  console.log('[debug] react-flow-app unmounting')
  root?.unmount()
  root = null
}

// ç‹¬ç«‹è¿è¡Œæ—¶çš„æŒ‚è½½
if (!window.__POWERED_BY_QIANKUN__) {
  mount({})
}
```

## åº”ç”¨é—´é€šä¿¡æœºåˆ¶

æœ¬é¡¹ç›®å®ç°äº†å¤šç§åº”ç”¨é—´é€šä¿¡æœºåˆ¶ï¼Œä¸ºå¾®å‰ç«¯æ¶æ„æä¾›äº†çµæ´»çš„æ•°æ®äº¤äº’æ–¹æ¡ˆã€‚

### åŸºäº Props çš„é€šä¿¡

ä¸»åº”ç”¨é€šè¿‡ qiankun æ³¨å†Œæ—¶çš„ props å‘å­åº”ç”¨ä¼ é€’æ•°æ®å’Œæ–¹æ³•ï¼š

```typescript
// ä¸»åº”ç”¨ä¸­æ³¨å†Œå­åº”ç”¨æ—¶ä¼ é€’ props
{
  name: 'flow',
  // å…¶ä»–é…ç½®...
  props: {
    navigateToOtherApp: mainNavigate,
    mainHistory: history,
    getGlobalState: () => store.getState(),
    bus,
    eventList: EVENT_LIST,
  },
}
```

å­åº”ç”¨åœ¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­æ¥æ”¶å¹¶ä½¿ç”¨è¿™äº› propsï¼š

```typescript
export const mount = async (props: QiankunMountProps) => {
  const { container, navigateToOtherApp, mainHistory } = props
  
  root.render(
    <AppContext.Provider value={{ navigateToOtherApp, mainHistory }}>
      <BrowserRouter basename={window.__POWERED_BY_QIANKUN__ ? '/flow' : '/'}>
        <Router />
      </BrowserRouter>
    </AppContext.Provider>
  )
}
```

å­åº”ç”¨ç»„ä»¶ä¸­é€šè¿‡ Context API ä½¿ç”¨è¿™äº›å…±äº«æ–¹æ³•ï¼š

```tsx
// å­åº”ç”¨ä¸­çš„ç»„ä»¶
function NavigationComponent() {
  const { navigateToOtherApp, mainHistory } = useAppContext()
  
  const handleToOtherMicroApp = () => {
    // ä½¿ç”¨ä¸»åº”ç”¨æä¾›çš„å¯¼èˆªæ–¹æ³•è¿›è¡Œè·¨åº”ç”¨å¯¼èˆª
    navigateToOtherApp?.('/backend')
    // æˆ–è€…ç›´æ¥ä½¿ç”¨ä¸»åº”ç”¨çš„ history å¯¹è±¡
    // mainHistory?.push('/backend')
  }
  
  return (
    <div className="flex gap-4">
      <button 
        onClick={handleToOtherMicroApp}
        className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
      >
        è·³è½¬åˆ° backend å¾®åº”ç”¨
      </button>
    </div>
  )
}
```

### äº‹ä»¶æ€»çº¿é€šä¿¡æœºåˆ¶

é¡¹ç›®å®ç°äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„äº‹ä»¶æ€»çº¿æœºåˆ¶ï¼Œç”¨äºåº”ç”¨é—´çš„å‘å¸ƒ-è®¢é˜…æ¨¡å¼é€šä¿¡ï¼š

```typescript
// äº‹ä»¶æ€»çº¿å®ç° (app/main/src/shared/eventBus.ts)
export const EVENT_LIST = {
  ROUTE_NAVIGATE: Symbol.for('MAIN.ROUTE_NAVIGATE'),
  USER_LOGIN: Symbol.for('MAIN.USER_LOGIN'),
  THEME_CHANGE: Symbol.for('MAIN.THEME_CHANGE'),
} as const

type EventType = symbol
type EventHandler<T = unknown> = (data?: T) => void

class EventBus {
  #topics = new Map<EventType, EventHandler[]>()

  subscribe<T>(event: EventType, callback: EventHandler<T>) {
    const handlers = this.#topics.get(event) || []
    this.#topics.set(event, [...handlers, callback as EventHandler<unknown>])
  }

  publish<T>(event: EventType, data?: T) {
    const handlers = this.#topics.get(event)
    for (const handler of handlers || []) {
      if (typeof handler !== 'function') return

      try {
        data !== undefined ? handler(data as T) : handler()
      } catch (error) {
        console.error(`[EventBus] ${event.toString()}`, error)
      }
    }
  }

  unsubscribe(event: EventType, callback: EventHandler) {
    const handlers = this.#topics.get(event)
    if (!handlers) return

    this.#topics.set(
      event,
      handlers.filter((fn) => fn !== callback),
    )
  }

  clear(event: EventType) {
    this.#topics.delete(event)
  }
}

export default new EventBus()
```

é€šä¿¡ç¤ºä¾‹ï¼š

```typescript
// ä¸»åº”ç”¨ä¼ é€’äº‹ä»¶æ€»çº¿
props: {
  bus,
  eventList: EVENT_LIST,
}

// å­åº”ç”¨è®¢é˜…äº‹ä»¶
useEffect(() => {
  const handleRouteChange = (path: string) => {
    console.log(`Route changed to: ${path}`)
    // å¤„ç†è·¯ç”±å˜æ›´é€»è¾‘
  }
  
  const handleUserLogin = (user: User) => {
    console.log('User logged in:', user)
    // å¤„ç†ç”¨æˆ·ç™»å½•çŠ¶æ€
  }
  
  props.bus?.subscribe(props.eventList.ROUTE_NAVIGATE, handleRouteChange)
  props.bus?.subscribe(props.eventList.USER_LOGIN, handleUserLogin)
  
  return () => {
    props.bus?.unsubscribe(props.eventList.ROUTE_NAVIGATE, handleRouteChange)
    props.bus?.unsubscribe(props.eventList.USER_LOGIN, handleUserLogin)
  }
}, [props.bus, props.eventList])

// å­åº”ç”¨å‘å¸ƒäº‹ä»¶
const notifyRouteChange = (path: string) => {
  props.bus?.publish(props.eventList.ROUTE_NAVIGATE, path)
}

const notifyUserLogin = (user: User) => {
  props.bus?.publish(props.eventList.USER_LOGIN, user)
}
```

### å…±äº«å…¨å±€çŠ¶æ€

é¡¹ç›®ä½¿ç”¨ zustand å®ç°å…¨å±€çŠ¶æ€ç®¡ç†ï¼Œå¹¶é€šè¿‡ props ä¼ é€’ç»™å­åº”ç”¨ï¼š

```typescript
// ä¸»åº”ç”¨å…¨å±€çŠ¶æ€å®šä¹‰ (app/main/src/store/globalStore.ts)
import { create } from 'zustand'
import { immer } from 'zustand/middleware/immer'

export interface GlobalState {
  microAppsLoading: MicroAppsLoading
  count: number
  user: User | null
  theme: 'light' | 'dark'
  setCount: (newCounter: number) => void
  setUser: (user: User | null) => void
  setTheme: (theme: 'light' | 'dark') => void
}

export const useGlobalStore = create<GlobalState>()(
  immer((set) => ({
    microAppsLoading: {},
    count: 0,
    user: null,
    theme: 'light',
    setCount: (newCounter: number) => set({ count: newCounter }),
    setUser: (user: User | null) => set({ user }),
    setTheme: (theme: 'light' | 'dark') => set({ theme }),
  })),
)

// å­åº”ç”¨è·å–å’Œä½¿ç”¨å…¨å±€çŠ¶æ€
const SubAppComponent = (props) => {
  const globalState = props.getGlobalState()
  
  const handleIncrement = () => {
    // é€šè¿‡äº‹ä»¶æ€»çº¿é€šçŸ¥ä¸»åº”ç”¨æ›´æ–°çŠ¶æ€
    props.bus?.publish(props.eventList.UPDATE_COUNT, globalState.count + 1)
  }
  
  return (
    <div className="p-4">
      <h2>å½“å‰è®¡æ•°: {globalState.count}</h2>
      <button 
        onClick={handleIncrement}
        className="px-4 py-2 bg-green-500 text-white rounded"
      >
        å¢åŠ è®¡æ•°
      </button>
      <p>å½“å‰ä¸»é¢˜: {globalState.theme}</p>
      {globalState.user && <p>ç”¨æˆ·: {globalState.user.name}</p>}
    </div>
  )
}
```

### é€šä¿¡æœºåˆ¶å¯¹æ¯”ä¸é€‰æ‹©

| é€šä¿¡æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|------|------|
| Props ä¼ é€’ | çˆ¶å­å…³ç³»æ˜ç¡®çš„åº”ç”¨é—´ | ç®€å•ç›´æ¥ï¼Œç±»ä¼¼ç»„ä»¶ props | ä»…é€‚ç”¨äºä¸»å­åº”ç”¨é—´é€šä¿¡ |
| äº‹ä»¶æ€»çº¿ | ä»»æ„åº”ç”¨é—´çš„æ¾æ•£é€šä¿¡ | å®Œå…¨è§£è€¦ï¼Œçµæ´»æ€§é«˜ | äº‹ä»¶ç®¡ç†å¤æ‚ï¼Œè°ƒè¯•å›°éš¾ |
| å…¨å±€çŠ¶æ€å…±äº« | éœ€è¦å…±äº«æ•°æ®çš„åœºæ™¯ | ç»Ÿä¸€çŠ¶æ€ç®¡ç†ï¼Œä¾¿äºè¿½è¸ª | å¯èƒ½é€ æˆä¸å¿…è¦çš„é‡æ¸²æŸ“ |

**æœ€ä½³å®è·µå»ºè®®**ï¼š
- ä¸»å­åº”ç”¨é—´ç®€å•é€šä¿¡ï¼šä½¿ç”¨ Props ä¼ é€’
- å­åº”ç”¨é—´é€šä¿¡ï¼šä½¿ç”¨äº‹ä»¶æ€»çº¿
- å…¨å±€å…±äº«æ•°æ®ï¼šä½¿ç”¨å…±äº«çŠ¶æ€ç®¡ç†

## æ ·å¼éš”ç¦»ä¸æ²™ç®±æœºåˆ¶

### æ ·å¼éš”ç¦»å®ç°

é¡¹ç›®ä½¿ç”¨ qiankun æä¾›çš„ä¸¥æ ¼æ ·å¼éš”ç¦»æœºåˆ¶ï¼Œé˜²æ­¢å­åº”ç”¨æ ·å¼ç›¸äº’å½±å“ï¼š

```typescript
import { start } from 'qiankun'

start({
  sandbox: {
    strictStyleIsolation: true, // ä¸¥æ ¼æ ·å¼éš”ç¦»ï¼Œåˆ›å»º Shadow DOM
    // æˆ–è€…ä½¿ç”¨å®éªŒæ€§çš„ä½œç”¨åŸŸéš”ç¦»
    // experimentalStyleIsolation: true
  },
})
```

qiankun æä¾›äº†å¤šç§æ ·å¼éš”ç¦»æ–¹æ¡ˆï¼š

1. **åŠ¨æ€æ ·å¼éš”ç¦»ï¼ˆé»˜è®¤ï¼‰**ï¼šå­åº”ç”¨åŠ è½½æ—¶æ³¨å…¥æ ·å¼ï¼Œå¸è½½æ—¶ç§»é™¤
2. **Shadow DOM æ²™ç®±ï¼ˆä¸¥æ ¼éš”ç¦»ï¼‰**ï¼šä½¿ç”¨æµè§ˆå™¨åŸç”Ÿ Shadow DOM å®ç°éš”ç¦»
3. **ä½œç”¨åŸŸæ²™ç®±ï¼ˆå®éªŒæ€§ï¼‰**ï¼šä¸ºå­åº”ç”¨æ·»åŠ å”¯ä¸€éšæœºå±æ€§ï¼Œé‡å†™ CSS é€‰æ‹©å™¨

```css
/* å­åº”ç”¨æ ·å¼ç¤ºä¾‹ */
.micro-app-container {
  /* ä½¿ç”¨ CSS æ¨¡å—åŒ–æˆ–è€… CSS-in-JS æ¥é¿å…æ ·å¼å†²çª */
  background: #f5f5f5;
  padding: 20px;
}

/* å¦‚æœä½¿ç”¨ä½œç”¨åŸŸéš”ç¦»ï¼Œqiankun ä¼šè‡ªåŠ¨æ·»åŠ å‰ç¼€ */
.micro-app-container[data-qiankun-microapp="flow"] {
  /* æ ·å¼åªä¼šåº”ç”¨åˆ° flow å­åº”ç”¨ */
}
```

**æ³¨æ„**: åœ¨ qiankun 3.0 ä¸­ï¼Œ`strictStyleIsolation` å°†è¢«ç§»é™¤ï¼Œè½¬è€Œä½¿ç”¨ `experimentalStyleIsolation`ï¼ˆæ·»åŠ å‰ç¼€ç±»åçš„æ–¹å¼ï¼‰è¿›è¡Œæ ·å¼éš”ç¦»ã€‚

### JS æ²™ç®±æœºåˆ¶

qiankun æä¾›äº†ä¸‰ç§ JS æ²™ç®±æœºåˆ¶ï¼š

1. **SnapshotSandbox**ï¼šé€šè¿‡è®°å½•å’Œæ¢å¤ window å¯¹è±¡å¿«ç…§å®ç°éš”ç¦»
2. **LegacySandbox**ï¼šé€šè¿‡ Proxy ä»£ç† window å¯¹è±¡ï¼Œè·Ÿè¸ªä¿®æ”¹
3. **ProxySandbox**ï¼šä¸ºæ¯ä¸ªå­åº”ç”¨åˆ›å»ºç‹¬ç«‹çš„è™šæ‹Ÿ window ä»£ç†

```typescript
// qiankun è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æ²™ç®±æœºåˆ¶
start({
  sandbox: {
    // å¯ä»¥æ‰‹åŠ¨æŒ‡å®šæ²™ç®±ç±»å‹
    loose: false, // æ˜¯å¦ä½¿ç”¨å®½æ¾æ²™ç®±æ¨¡å¼
  },
})
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œqiankun æ ¹æ®æµè§ˆå™¨æ”¯æŒå’Œåº”ç”¨é…ç½®è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æ²™ç®±æœºåˆ¶ã€‚

## å‰ç«¯åº”ç”¨æ‹†åˆ†ç­–ç•¥

### æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†

å„å­åº”ç”¨æŒ‰ç…§ä¸šåŠ¡åŠŸèƒ½è¿›è¡Œæ‹†åˆ†ï¼Œå„è‡ªç‹¬ç«‹ç»´æŠ¤è‡ªå·±çš„è·¯ç”±ã€çŠ¶æ€å’Œç»„ä»¶ï¼š

```typescript
// ä¸šåŠ¡æ‹†åˆ†ç¤ºä¾‹
const microApps = [
  {
    name: 'user-management',    // ç”¨æˆ·ç®¡ç†æ¨¡å—
    activeRule: '/users',
    technologies: ['React', 'TypeScript', 'Ant Design']
  },
  {
    name: 'order-system',       // è®¢å•ç³»ç»Ÿæ¨¡å—
    activeRule: '/orders',
    technologies: ['Vue', 'TypeScript', 'Element Plus']
  },
  {
    name: 'analytics-dashboard', // æ•°æ®åˆ†ææ¨¡å—
    activeRule: '/analytics',
    technologies: ['React', 'D3.js', 'Chart.js']
  },
  {
    name: 'content-management',  // å†…å®¹ç®¡ç†æ¨¡å—
    activeRule: '/content',
    technologies: ['Vue', 'Quill', 'TinyMCE']
  }
]
```

### æŠ€æœ¯æ ˆç‹¬ç«‹

å­åº”ç”¨å¯ä»¥ä½¿ç”¨ä¸åŒçš„å‰ç«¯æ¡†æ¶ï¼ˆReactã€Vueï¼‰ï¼Œå®ç°æŠ€æœ¯æ ˆè§£è€¦ï¼š

```json
// React å­åº”ç”¨çš„ package.json
{
  "name": "@micro/flow-app",
  "dependencies": {
    "react": "^18.0.0",
    "react-dom": "^18.0.0",
    "react-router-dom": "^6.0.0",
    "antd": "^5.0.0"
  }
}

// Vue å­åº”ç”¨çš„ package.json
{
  "name": "@micro/backend-app",
  "dependencies": {
    "vue": "^3.0.0",
    "vue-router": "^4.0.0",
    "element-plus": "^2.0.0",
    "pinia": "^2.0.0"
  }
}
```

### ç‹¬ç«‹å¼€å‘ä¸æ„å»º

æ¯ä¸ªåº”ç”¨æœ‰è‡ªå·±çš„å¼€å‘å’Œæ„å»ºå‘½ä»¤ï¼Œæ”¯æŒç‹¬ç«‹å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²ï¼š

```json
{
  "scripts": {
    "dev": "pnpm --parallel run dev",
    "dev:main": "pnpm --filter main dev",
    "dev:flow": "pnpm --filter flow dev:micro",
    "dev:backend": "pnpm --filter backend dev:micro",
    "build": "pnpm --recursive run build",
    "build:main": "pnpm --filter main build",
    "build:flow": "pnpm --filter flow build:micro",
    "build:backend": "pnpm --filter backend build:micro"
  }
}
```

## éƒ¨ç½²æ–¹æ¡ˆè¯¦è§£

### Nginx é…ç½®ç­–ç•¥

Nginx ç”¨äºè·¯ç”±åˆ†å‘ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„å­åº”ç”¨æœåŠ¡ï¼š

```nginx
# nginx.conf
upstream main {
    server 127.0.0.1:3000;
}

upstream flow {
    server 127.0.0.1:3001;
}

upstream backend {
    server 127.0.0.1:3002;
}

server {
    listen 80;
    server_name micro.app.example.com;

    # ä¸»åº”ç”¨è·¯ç”±
    location / {
        proxy_pass http://main;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # æ”¯æŒ WebSocketï¼ˆå¦‚æœéœ€è¦çƒ­é‡è½½ï¼‰
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # flow å­åº”ç”¨é™æ€èµ„æº
    location /app-flow/ {
        proxy_pass http://flow/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # backend å­åº”ç”¨é™æ€èµ„æº
    location /app-backend/ {
        proxy_pass http://backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # é™æ€èµ„æºç¼“å­˜ç­–ç•¥
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri @proxy;
    }

    location @proxy {
        proxy_pass http://main;
    }
}
```

### é™æ€èµ„æºéƒ¨ç½²

é¡¹ç›®é™æ€èµ„æºéƒ¨ç½²ç­–ç•¥ï¼š

```typescript
// ä¸»åº”ç”¨ webpack/rspack é…ç½®
export default {
  output: {
    publicPath: '/', // æˆ– CDN ç»å¯¹è·¯å¾„
  },
  // å…¶ä»–é…ç½®...
}

// å­åº”ç”¨é…ç½®
export default {
  output: {
    publicPath: window.__POWERED_BY_QIANKUN__ ? '/app-flow/' : '/',
    library: `flow-[name]`,
    libraryTarget: 'umd',
    globalObject: 'window',
  },
  // å…¶ä»–é…ç½®...
}
```

### PM2 è¿›ç¨‹ç®¡ç†

ä½¿ç”¨ PM2 ç®¡ç†å„ä¸ªåº”ç”¨çš„ Node æœåŠ¡è¿›ç¨‹ï¼š

```javascript
// ecosystem.config.cjs
module.exports = {
  apps: [
    {
      name: "micro-main",
      script: "./app/main/dist/server.js",
      instances: 2,
      exec_mode: "cluster",
      env: {
        NODE_ENV: "production",
        PORT: 3000
      },
      error_file: "./logs/main-error.log",
      out_file: "./logs/main-out.log",
      log_file: "./logs/main-combined.log"
    },
    {
      name: "micro-flow",
      script: "./app/flow/dist/server.js",
      instances: 1,
      env: {
        NODE_ENV: "production",
        PORT: 3001
      },
      error_file: "./logs/flow-error.log",
      out_file: "./logs/flow-out.log"
    },
    {
      name: "micro-backend",
      script: "./app/backend/dist/server.js",
      instances: 1,
      env: {
        NODE_ENV: "production",
        PORT: 3002
      },
      error_file: "./logs/backend-error.log",
      out_file: "./logs/backend-out.log"
    }
  ]
}
```

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### å­åº”ç”¨é—´è·³è½¬çš„æ—¶åºé—®é¢˜

#### é—®é¢˜æè¿°

åœ¨å­åº”ç”¨ flow ä¸­ä½¿ç”¨ `history.pushState` è·³è½¬åˆ°å¦ä¸€ä¸ªå­åº”ç”¨ backend æ—¶ï¼Œä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š

```
[qiankun]: Target container with #backend not existed while backend loading!
```

è¿™æ˜¯å› ä¸ºå­åº”ç”¨çš„èµ„æºå·²ç»åŠ è½½å®Œæˆï¼Œä½†å¯¹åº”çš„å®¹å™¨èŠ‚ç‚¹è¿˜æœªæŒ‚è½½åˆ°é¡µé¢ä¸Šã€‚

#### é—®é¢˜åˆ†æ

è¯¦ç»†åˆ†æçš„æ—¶åºé—®é¢˜ï¼š

1. å¼€å¯ prefetch æ—¶ï¼Œqiankun ä¼šé¢„åŠ è½½ backend å­åº”ç”¨çš„èµ„æº
2. å½“åœ¨ flow å­åº”ç”¨ä¸­è°ƒç”¨ `history.pushState` è·³è½¬åˆ° `/backend` æ—¶
3. qiankun ç›‘å¬åˆ° URL å˜åŒ–ï¼Œç«‹å³å°è¯•åŠ è½½å¹¶æŒ‚è½½ backend åº”ç”¨
4. ä½†æ­¤æ—¶ä¸»åº”ç”¨çš„è·¯ç”±ç³»ç»Ÿï¼ˆReact Routerï¼‰è¿˜æ²¡æœ‰å“åº” URL å˜åŒ–
5. å¯¼è‡´ backend å­åº”ç”¨çš„å®¹å™¨å…ƒç´  `#backend` å°šæœªæ¸²æŸ“ï¼ŒæŒ‚è½½å¤±è´¥

#### è§£å†³æ–¹æ¡ˆ

æœ‰ä»¥ä¸‹å‡ ç§è§£å†³æ–¹æ¡ˆï¼š

**æ–¹æ¡ˆä¸€ï¼šå…³é—­é¢„åŠ è½½ï¼ˆprefetch: falseï¼‰**
```typescript
start({
  prefetch: false, // å…³é—­é¢„åŠ è½½
  // å…¶ä»–é…ç½®...
})
```

**æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ä¸»åº”ç”¨æä¾›çš„å¯¼èˆªæ–¹æ³•ï¼ˆæ¨èï¼‰**
```typescript
// å­åº”ç”¨ä¸­ä½¿ç”¨ä¸»åº”ç”¨æä¾›çš„æ–¹æ³•è¿›è¡Œå¯¼èˆª
const NavigationButton = () => {
  const { navigateToOtherApp, mainHistory } = useAppContext()
  
  const handleToOtherMicroApp = () => {
    // æ¨èæ–¹å¼ï¼šä½¿ç”¨ä¸»åº”ç”¨æä¾›çš„å¯¼èˆªå‡½æ•°
    navigateToOtherApp?.('/backend')
    
    // æˆ–è€…ä½¿ç”¨ä¸»åº”ç”¨çš„ history å¯¹è±¡
    // mainHistory?.push('/backend')
  }
  
  return (
    <button onClick={handleToOtherMicroApp}>
      è·³è½¬åˆ° backend å¾®åº”ç”¨
    </button>
  )
}
```

**æ–¹æ¡ˆä¸‰ï¼šæ·»åŠ å»¶è¿Ÿå¤„ç†**
```typescript
const handleNavigation = async (path: string) => {
  // å…ˆæ›´æ–° URL
  window.history.pushState(null, '', path)
  
  // ç­‰å¾…ä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œè®©ä¸»åº”ç”¨è·¯ç”±æœ‰æ—¶é—´å“åº”
  await new Promise(resolve => setTimeout(resolve, 0))
  
  // è§¦å‘ popstate äº‹ä»¶ï¼Œè®© qiankun é‡æ–°æ£€æŸ¥è·¯ç”±
  window.dispatchEvent(new PopStateEvent('popstate'))
}
```

**æœ€ä½³å®è·µ**ï¼šå­åº”ç”¨ä¹‹é—´çš„è·³è½¬åº”è¯¥é‡‡ç”¨ä¸»åº”ç”¨æä¾›çš„å¯¼èˆªå‡½æ•°ï¼Œè¿™æ˜¯å¾®å‰ç«¯æ¶æ„ä¸­çš„æ¨èåšæ³•ï¼Œå¯ç¡®ä¿è·¯ç”±æ§åˆ¶çš„ä¸€è‡´æ€§å’Œç¨³å®šæ€§ã€‚

### ä¸»åº”ç”¨ history æ¨¡å¼æ¥å…¥ hash æ¨¡å¼çš„å­åº”ç”¨

#### é—®é¢˜æè¿°

åœ¨ä¸»åº”ç”¨ä½¿ç”¨ history è·¯ç”±æ¨¡å¼ï¼Œå­åº”ç”¨ä½¿ç”¨ hash è·¯ç”±æ¨¡å¼æ—¶ï¼Œä¼šå‡ºç°è·¯ç”±åŒ¹é…å’Œåœ°å€æ æ˜¾ç¤ºçš„é—®é¢˜ã€‚

#### è§£å†³æ–¹æ¡ˆ

Vue å­åº”ç”¨éœ€è¦åœ¨åˆ›å»ºè·¯ç”±æ—¶æ­£ç¡®é…ç½® basenameï¼š

```typescript
// Vue3 å­åº”ç”¨è·¯ç”±é…ç½®
import { createRouter, createWebHashHistory } from 'vue-router'

const history = createWebHashHistory(
  window.__POWERED_BY_QIANKUN__ ? '/hash/#' : '/'
)

const router = createRouter({
  history,
  routes: [
    {
      path: '/',
      name: 'Home',
      component: () => import('@/views/Home.vue')
    },
    {
      path: '/about',
      name: 'About',
      component: () => import('@/views/About.vue')
    }
  ],
})

export default router
```

```typescript
// ä¸»åº”ç”¨æ­£å¸¸é…ç½®
registerMicroApps([
  {
    name: 'hash',
    entry: isDev ? '//localhost:23458' : '/app-hash/',
    container: '#hash',
    activeRule: '/hash', // ä¸»åº”ç”¨çš„è·¯ç”±è§„åˆ™
    props: {
      // ä¼ é€’å¿…è¦çš„ props
    },
  },
])
```

æœ€ç»ˆé¡µé¢ URL ä¼šæ˜¾ç¤ºä¸ºï¼š`http://xxx.com/hash/#/home`

#### è·¯ç”±æ¨¡å¼ç»„åˆå»ºè®®

| ç»„åˆæ¨¡å¼ | å¯è¡Œæ€§ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|-------|------|------|
| Hash ä¸» + History å­ | âŒ | - | URL å†²çªã€åˆ·æ–° 404 |
| History ä¸» + Hash å­ | âœ… | è·¯å¾„æ¸…æ™°ã€å…¼å®¹æ—§é¡¹ç›® | éœ€å­åº”ç”¨é€‚é… |
| History ä¸» + History å­ | âœ… | æœ€ä½³å®è·µã€SEO å‹å¥½ | éœ€æœåŠ¡ç«¯é…ç½® |
| Hash ä¸» + Hash å­ | âœ… | æ— éœ€æœåŠ¡ç«¯é…ç½® | URL å†—ä½™ |

æ¨èä½¿ç”¨ **History ä¸» + History å­** æˆ– **Hash ä¸» + Hash å­** çš„ç»„åˆï¼Œé¿å…æ··åˆæ¨¡å¼å¸¦æ¥çš„é£é™©ã€‚

### publicPath é…ç½®é—®é¢˜

#### é—®é¢˜æè¿°

ä¸»åº”ç”¨çš„ publicPath å¦‚æœé…ç½®ä¸æ­£ç¡®ï¼Œä¼šå¯¼è‡´åœ¨æµè§ˆå™¨ç›´æ¥è¾“å…¥ URL è®¿é—®å­åº”ç”¨é¡µé¢å¤±è´¥ã€‚

#### è§£å†³æ–¹æ¡ˆ

```javascript
// ä¸»åº”ç”¨ webpack/rspack é…ç½®
module.exports = {
  output: {
    publicPath: '/',  // å¿…é¡»æ˜¯æ ¹ç›®å½•æˆ– CDN ç»å¯¹è·¯å¾„
    // ä¸èƒ½ä½¿ç”¨ç›¸å¯¹è·¯å¾„å¦‚ './'
  },
  // å…¶ä»–é…ç½®...
}

// å­åº”ç”¨é…ç½®
module.exports = {
  output: {
    publicPath: window.__POWERED_BY_QIANKUN__ ? '/app-flow/' : '/',
    library: `flow-[name]`,
    libraryTarget: 'umd',
    globalObject: 'window',
  },
  // å…¶ä»–é…ç½®...
}
```

**å…³é”®ç‚¹**ï¼š
- ä¸»åº”ç”¨çš„ publicPath å¿…é¡»è®¾ç½®ä¸ºæ ¹ç›®å½• `/` æˆ– CDN çš„ç»å¯¹è·¯å¾„
- ä¸èƒ½ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ `./`ï¼‰ï¼Œå¦åˆ™ä¼šå¯¼è‡´å­åº”ç”¨ URL çš„è®¿é—®é—®é¢˜
- å­åº”ç”¨å¯ä»¥ä½¿ç”¨å„è‡ªçš„ publicPath é…ç½®

### å¼€å‘ç¯å¢ƒè·¨åŸŸé—®é¢˜

#### é—®é¢˜æè¿°

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œä¸»åº”ç”¨å’Œå­åº”ç”¨è¿è¡Œåœ¨ä¸åŒç«¯å£ï¼Œä¼šå‡ºç°è·¨åŸŸé—®é¢˜ã€‚

#### è§£å†³æ–¹æ¡ˆ

```typescript
// å­åº”ç”¨å¼€å‘æœåŠ¡å™¨é…ç½®
export default {
  devServer: {
    port: 3001,
    headers: {
      'Access-Control-Allow-Origin': '*', // å…è®¸è·¨åŸŸ
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, PATCH, OPTIONS',
      'Access-Control-Allow-Headers': 'X-Requested-With, content-type, Authorization',
    },
  },
  // å…¶ä»–é…ç½®...
}

// æˆ–è€…åœ¨ä¸»åº”ç”¨ä¸­é…ç½®ä»£ç†
export default {
  devServer: {
    proxy: {
      '/api': {
        target: 'http://localhost:3001',
        changeOrigin: true,
        pathRewrite: {
          '^/api': '',
        },
      },
    },
  },
}
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### èµ„æºé¢„åŠ è½½ç­–ç•¥

```typescript
// æ™ºèƒ½é¢„åŠ è½½é…ç½®
start({
  prefetch: 'all', // é¢„åŠ è½½æ‰€æœ‰å­åº”ç”¨èµ„æº
  // æˆ–è€…
  prefetch: (apps) => {
    // è‡ªå®šä¹‰é¢„åŠ è½½é€»è¾‘
    return apps.filter(app => app.name !== 'heavy-app')
  },
})
```

### ä»£ç åˆ†å‰²ä¼˜åŒ–

```typescript
// å­åº”ç”¨ä¸­ä½¿ç”¨æ‡’åŠ è½½
const LazyComponent = React.lazy(() => import('./HeavyComponent'))

function App() {
  return (
    <div>
      <Suspense fallback={<div>Loading...</div>}>
        <LazyComponent />
      </Suspense>
    </div>
  )
}
```

### ç¼“å­˜ç­–ç•¥

```typescript
// åˆ©ç”¨æµè§ˆå™¨ç¼“å­˜
const webpackConfig = {
  output: {
    filename: '[name].[contenthash].js',
    chunkFilename: '[name].[contenthash].chunk.js',
  },
  optimization: {
    splitChunks: {
      chunks: 'all',
      cacheGroups: {
        vendor: {
          test: /[\\/]node_modules[\\/]/,
          name: 'vendors',
          chunks: 'all',
        },
      },
    },
  },
}
```

## ç›‘æ§ä¸è°ƒè¯•

### åº”ç”¨çŠ¶æ€ç›‘æ§

```typescript
// ç›‘æ§å­åº”ç”¨åŠ è½½çŠ¶æ€
import { addGlobalUncaughtErrorHandler } from 'qiankun'

addGlobalUncaughtErrorHandler((event) => {
  console.error('å­åº”ç”¨åŠ è½½å‡ºé”™:', event)
  // å‘é€é”™è¯¯æ—¥å¿—åˆ°ç›‘æ§ç³»ç»Ÿ
  sendErrorLog({
    type: 'micro-app-error',
    message: event.message,
    stack: event.error?.stack,
    timestamp: Date.now(),
  })
})
```

### æ€§èƒ½ç›‘æ§

```typescript
// ç›‘æ§å­åº”ç”¨æ€§èƒ½
const performanceObserver = new PerformanceObserver((list) => {
  list.getEntries().forEach((entry) => {
    if (entry.name.includes('micro-app')) {
      console.log(`å­åº”ç”¨ ${entry.name} åŠ è½½æ—¶é—´:`, entry.duration)
    }
  })
})

performanceObserver.observe({ entryTypes: ['navigation', 'resource'] })
```

## æ€»ç»“ä¸æœ€ä½³å®è·µ

é€šè¿‡ qiankun å¾®å‰ç«¯æ¡†æ¶ï¼Œé¡¹ç›®å®ç°äº†å‰ç«¯åº”ç”¨çš„æ¨¡å—åŒ–æ‹†åˆ†å’Œç‹¬ç«‹éƒ¨ç½²ï¼Œæ—¢ä¿è¯äº†å„å›¢é˜Ÿçš„å¼€å‘è‡ªç”±åº¦ï¼Œåˆç»´æŒäº†æ•´ä½“åº”ç”¨çš„ä¸€è‡´æ€§ä½“éªŒã€‚

### æ ¸å¿ƒä¼˜åŠ¿

1. **æŠ€æœ¯æ ˆæ— å…³**ï¼šæ”¯æŒ Reactã€Vue ç­‰ä¸åŒæ¡†æ¶å…±å­˜
2. **ç‹¬ç«‹å¼€å‘éƒ¨ç½²**ï¼šå„å­åº”ç”¨å¯ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²
3. **æ¸è¿›å¼å‡çº§**ï¼šå¯é€æ­¥å°†è€é¡¹ç›®æ”¹é€ ä¸ºå¾®å‰ç«¯æ¶æ„
4. **å›¢é˜Ÿåä½œ**ï¼šä¸åŒå›¢é˜Ÿå¯å¹¶è¡Œå¼€å‘ï¼Œæé«˜æ•ˆç‡

### æœ€ä½³å®è·µæ€»ç»“

1. **åº”ç”¨æ‹†åˆ†**ï¼šæŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†ï¼Œé¿å…è¿‡åº¦æ‹†åˆ†
2. **é€šä¿¡æœºåˆ¶**ï¼šä¼˜å…ˆä½¿ç”¨ Props ä¼ é€’ï¼Œå¤æ‚åœºæ™¯ä½¿ç”¨äº‹ä»¶æ€»çº¿
3. **æ ·å¼éš”ç¦»**ï¼šä½¿ç”¨ä¸¥æ ¼æ¨¡å¼æˆ–ä½œç”¨åŸŸéš”ç¦»
4. **è·¯ç”±è®¾è®¡**ï¼šç»Ÿä¸€ä½¿ç”¨ History æ¨¡å¼ï¼Œé¿å…æ··åˆè·¯ç”±
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†é…ç½®é¢„åŠ è½½ï¼Œä½¿ç”¨ä»£ç åˆ†å‰²
6. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯è¾¹ç•Œå’Œç›‘æ§æœºåˆ¶

### é€‚ç”¨åœºæ™¯

å¾®å‰ç«¯æ¶æ„ç‰¹åˆ«é€‚åˆä»¥ä¸‹åœºæ™¯ï¼š

- **å¤§å‹ä¼ä¸šåº”ç”¨**ï¼šå¤šå›¢é˜Ÿåä½œï¼Œä¸šåŠ¡æ¨¡å—å¤æ‚
- **é—ç•™ç³»ç»Ÿæ”¹é€ **ï¼šéœ€è¦æ¸è¿›å¼å‡çº§è€ç³»ç»Ÿ
- **å¤šæŠ€æœ¯æ ˆå¹¶å­˜**ï¼šå›¢é˜Ÿä½¿ç”¨ä¸åŒçš„å‰ç«¯æŠ€æœ¯æ ˆ
- **ç‹¬ç«‹å‘å¸ƒéœ€æ±‚**ï¼šä¸åŒæ¨¡å—éœ€è¦ç‹¬ç«‹å‘å¸ƒä¸Šçº¿

é€šè¿‡è¿™ç§æ¶æ„ï¼Œå¯ä»¥æ˜¾è‘—æé«˜å¼€å‘æ•ˆç‡ï¼Œé™ä½åº”ç”¨é—´çš„è€¦åˆåº¦ï¼Œå®ç°å›¢é˜Ÿé—´çš„å¹¶è¡Œå¼€å‘å’Œç‹¬ç«‹éƒ¨ç½²ï¼Œæœ€ç»ˆå®ç°å¤§å‹å‰ç«¯åº”ç”¨çš„å¯æŒç»­å‘å±•ã€‚

---

*å¾®å‰ç«¯ä¸æ˜¯é“¶å¼¹ï¼Œä½†åœ¨åˆé€‚çš„åœºæ™¯ä¸‹ï¼Œå®ƒç¡®å®èƒ½å¤Ÿè§£å†³è®¸å¤šå¤§å‹å‰ç«¯åº”ç”¨é¢ä¸´çš„é—®é¢˜ã€‚é€‰æ‹©å¾®å‰ç«¯æ¶æ„æ—¶ï¼Œè¯·æ ¹æ®å›¢é˜Ÿè§„æ¨¡ã€ä¸šåŠ¡å¤æ‚åº¦å’ŒæŠ€æœ¯æ ˆæƒ…å†µåšå‡ºç†æ€§å†³ç­–ã€‚*